<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Accelerometer</title>

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
}

.card{
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 15px 40px rgba(0,0,0,0.08);
  width:350px;
  text-align:center;
}

h2{
  margin-top:0;
  color:#1e293b;
}

.device{
  background:#f1f5f9;
  padding:10px;
  border-radius:12px;
  font-size:13px;
  margin-bottom:15px;
  color:#334155;
}

.sensor{
  font-size:18px;
  font-weight:600;
  margin:10px 0;
  color:#0f172a;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  margin-bottom:10px;
}

.start{ background:#6366f1; color:white; }
.stop{ background:#ef4444; color:white; }
.latest{ background:#0ea5e9; color:white; }

.status{
  margin-top:8px;
  font-weight:600;
}

.running{ color:#16a34a; }
.stopped{ color:#ef4444; }
.idle{ color:#64748b; }

.counter{
  font-size:14px;
  color:#64748b;
  margin-bottom:10px;
}

pre{
  background:#0f172a;
  color:#22d3ee;
  padding:10px;
  border-radius:10px;
  font-size:12px;
  text-align:left;
  max-height:120px;
  overflow:auto;
}
</style>
</head>

<body>

<div class="card">

<h2>ðŸ“± Accelerometer</h2>

<div class="device">
Device ID:<br>
<b id="deviceLabel"></b>
</div>

<div class="sensor" id="live">
x: 0.00<br>
y: 0.00<br>
z: 0.00
</div>

<button class="start" onclick="start()">Start</button>
<button class="stop" onclick="stop()">Stop</button>
<button class="latest" onclick="getLatest()">Get Latest</button>

<div class="status idle" id="status">Idle</div>
<div class="counter">Collected: <span id="count">0</span></div>

<pre id="latestData"></pre>

</div>

<script>
const BASE="https://script.google.com/macros/s/AKfycbyTPZsVHNWOo176DZBhExkDSzy2cSriBxttIQ4-pp5xbBM_sUSPaMqRk1UofhPxStQ/exec";

// ================= DEVICE ID (SAMA DENGAN SCAN) =================
function getDeviceId(){
  let id=localStorage.getItem("device_id");
  if(!id){
    id="web-"+crypto.randomUUID();
    localStorage.setItem("device_id",id);
  }
  return id;
}
const device_id=getDeviceId();
document.getElementById("deviceLabel").innerText=device_id;

// ================= VAR =================
let samples=[];
let timerSend=null;
let motionHandler=null;
let isRunning=false;

const live=document.getElementById("live");
const statusEl=document.getElementById("status");
const countEl=document.getElementById("count");
const latestBox=document.getElementById("latestData");

// ================= START =================
async function start(){

  if(isRunning) return;

  if(typeof DeviceMotionEvent==="undefined"){
    alert("DeviceMotion tidak didukung");
    return;
  }

  if(typeof DeviceMotionEvent.requestPermission==="function"){
    const permission=await DeviceMotionEvent.requestPermission();
    if(permission!=="granted"){
      alert("Permission ditolak");
      return;
    }
  }

  isRunning=true;
  statusEl.innerText="Running";
  statusEl.className="status running";

  motionHandler=e=>{
    const acc=e.accelerationIncludingGravity;
    if(!acc) return;

    const x=acc.x||0;
    const y=acc.y||0;
    const z=acc.z||0;

    live.innerHTML=
`x: ${x.toFixed(2)}<br>
y: ${y.toFixed(2)}<br>
z: ${z.toFixed(2)}`;

    samples.push({
      t:new Date().toISOString(),
      x:x,
      y:y,
      z:z
    });

    countEl.innerText=samples.length;
  };

  window.addEventListener("devicemotion",motionHandler);
  timerSend=setInterval(sendBatch,3000);
}

// ================= STOP =================
function stop(){
  if(!isRunning) return;

  isRunning=false;
  clearInterval(timerSend);

  window.removeEventListener("devicemotion",motionHandler);

  statusEl.innerText="Stopped";
  statusEl.className="status stopped";

  samples=[];
  countEl.innerText=0;
}

// ================= SEND =================
async function sendBatch(){

  if(samples.length===0) return;

  const payload={
    device_id:device_id,
    ts:new Date().toISOString(),
    samples:samples
  };

  samples=[];

  try{
    const res=await fetch(BASE_URL+"?path=/telemetry/accel",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    const json=await res.json();
    console.log("POST:",json);

  }catch(err){
    console.log("Send error");
  }

  countEl.innerText=0;
}

// ================= GET LATEST =================
async function getLatest(){
  try{
    const res=await fetch(
      BASE_URL+"?path=/telemetry/accel/latest&device_id="+device_id
    );

    const json=await res.json();

    if(json.ok){
      latestBox.innerText=JSON.stringify(json.data,null,2);
    }

  }catch(err){
    console.log("Latest error");
  }
}
</script>

</body>
</html>