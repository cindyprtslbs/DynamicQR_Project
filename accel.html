<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Accelerometer Client</title>
</head>
<body>

<h2>Accelerometer Telemetry</h2>

<p>Device ID: <input type="text" id="deviceId" value="dev-001"></p>
<button onclick="startAccel()">Start</button>
<button onclick="stopAccel()">Stop</button>
<button onclick="getLatest()">Get Latest</button>

<h3>Latest Data:</h3>
<pre id="output"></pre>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbyTPZsVHNWOo176DZBhExkDSzy2cSriBxttIQ4-pp5xbBM_sUSPaMqRk1UofhPxStQ/exec"; 

let samples = [];
let motionHandler = null;
let intervalSender = null;

function startAccel() {

  if (typeof DeviceMotionEvent === "undefined") {
    alert("DeviceMotion tidak didukung di device ini");
    return;
  }

  samples = [];

  motionHandler = function(event) {
    const acc = event.accelerationIncludingGravity;

    if (!acc) return;

    samples.push({
      t: new Date().toISOString(),
      x: acc.x || 0,
      y: acc.y || 0,
      z: acc.z || 0
    });
  };

  window.addEventListener("devicemotion", motionHandler);

  // kirim batch tiap 5 detik
  intervalSender = setInterval(sendBatch, 5000);

  alert("Accelerometer started");
}

function stopAccel() {
  window.removeEventListener("devicemotion", motionHandler);
  clearInterval(intervalSender);
  alert("Stopped");
}

async function sendBatch() {

  if (samples.length === 0) return;

  const deviceId = document.getElementById("deviceId").value;

  const payload = {
    device_id: deviceId,
    ts: new Date().toISOString(),
    samples: samples
  };

  try {
    const res = await fetch(BASE_URL + "?path=/telemetry/accel", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("Sent:", data);

    samples = []; // reset setelah kirim

  } catch (err) {
    console.error("Error sending:", err);
  }
}

async function getLatest() {

  const deviceId = document.getElementById("deviceId").value;

  try {
    const res = await fetch(
      BASE_URL + "?path=/telemetry/accel/latest&device_id=" + deviceId
    );

    const data = await res.json();

    document.getElementById("output").textContent =
      JSON.stringify(data, null, 2);

  } catch (err) {
    console.error(err);
  }
}
</script>

</body>
</html>