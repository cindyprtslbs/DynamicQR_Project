<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scan Presensi</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
}

.card{
  background:white;
  padding:30px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  width:320px;
  text-align:center;
}

h2{
  margin-top:0;
  color:#1e293b;
}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #e2e8f0;
  font-size:14px;
  margin-bottom:15px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#6366f1;
  color:white;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}

#reader{
  width:260px;
  margin:15px auto;
}

#status{
  margin-top:15px;
  font-size:16px;
  font-weight:600;
}

.loading{ color:#0f172a; }
.success{ color:#16a34a; }
.error{ color:#dc2626; }

.footer{
  margin-top:15px;
  font-size:12px;
  color:#64748b;
}
</style>
</head>

<body>

<div class="card">

  <h2>Scan QR Presensi</h2>

  <!-- FORM NIM -->
  <div id="loginBox">
    <input id="nimInput" placeholder="Masukkan NIM">
    <button onclick="saveNIM()">Mulai Scan</button>
  </div>

  <!-- SCANNER -->
  <div id="scanBox" style="display:none;">
    <div id="reader"></div>
    <div id="status" class="loading">Siapkan kamera...</div>
    <div class="footer">Arahkan kamera ke QR Code</div>
  </div>

</div>

<script>
const BASE="https://script.google.com/macros/s/AKfycbxVG8oKaiMeiH5ksPCv5_DF2TLUEHiKY4lKOOcz3IsERclqG4-9duO-QEM-1fUxKjOu/exec";

// ================= UTILITY =================
function param(n){
  return new URL(location.href).searchParams.get(n);
}

// ================= PARAM =================
const token   = param("token");
const course  = param("course");
const session = param("session");

// ================= GLOBAL =================
let user_id = null;
const device_id = "web-" + Math.random().toString(36).substring(2,8);

// ================= SAVE NIM =================
function saveNIM(){
  const nim = nimInput.value.trim();
  if(!nim){
    alert("NIM wajib diisi");
    return;
  }

  user_id = nim;
  loginBox.style.display="none";
  scanBox.style.display="block";

  if(!token){
    startScanner();
  }else{
    checkin();
  }
}

// ================= CHECKIN =================
async function checkin(){

  setStatus("Mengirim presensi...", "loading");

  try{
    const res = await fetch(BASE+"?path=/presence/checkin",{
      method:"POST",
      body:JSON.stringify({
        user_id:user_id,
        device_id:device_id,
        course_id:course,
        session_id:session,
        qr_token:token,
        ts:new Date().toISOString()
      })
    });

    const json = await res.json();

    if(json.ok){
      setStatus("PRESENSI BERHASIL", "success");

      const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
      audio.play();
    }else{
      setStatus("❌ "+json.error, "error");
    }

  }catch(err){
    setStatus("❌ Gagal koneksi server", "error");
  }
}

function setStatus(text, type){
  status.innerText = text;
  status.className = type;
}

// ================= SCANNER =================
function startScanner(){
  const scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:220 },
    text=>{
      scanner.stop();
      location.href = text;
    }
  );
}

// ================= INIT =================
if(token){
  // kalau buka dari QR → tampil form NIM dulu
  loginBox.style.display="block";
  scanBox.style.display="none";
}else{
  // buka manual → input NIM dulu baru scan
  loginBox.style.display="block";
  scanBox.style.display="none";
}
</script>

</body>
</html>