<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scan Presensi</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
}

.card{
  background:white;
  padding:30px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  width:320px;
  text-align:center;
}

h2{ color:#1e293b; }

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #e2e8f0;
  margin-bottom:12px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#6366f1;
  color:white;
  font-weight:600;
  cursor:pointer;
}

#reader{ width:260px; margin:15px auto; }

#status{
  margin-top:15px;
  font-weight:600;
}

.loading{ color:#0f172a; }
.success{ color:#16a34a; }
.error{ color:#dc2626; }
</style>
</head>

<body>

<div class="card">

<h2>ðŸ“· Scan QR Presensi</h2>

<div id="loginBox">
  <input id="nimInput" placeholder="Masukkan NIM">
  <button onclick="saveNIM()">Mulai Scan</button>
</div>

<div id="scanBox" style="display:none;">
  <div id="reader"></div>
  <div id="status" class="loading">Siapkan kamera...</div>
</div>

</div>

<script>
const BASE="https://script.google.com/macros/s/AKfycbwf6MESxK6UjX7bdVgvdQwDKHNIyzV9X6MGmJK3w46Lr2lMblg66ps_WIN0NsM7XJdS/exec";

// DOM
const loginBox = document.getElementById("loginBox");
const scanBox  = document.getElementById("scanBox");
const nimInput = document.getElementById("nimInput");
const statusEl = document.getElementById("status");

// PARAM
function param(n){
  return new URL(location.href).searchParams.get(n);
}
const token   = param("token");
const course  = param("course");
const session = param("session");

// USER
let user_id = localStorage.getItem("nim");
const device_id = "web-" + Math.random().toString(36).substring(2,8);

// INIT
if(user_id){
  loginBox.style.display="none";
  scanBox.style.display="block";

  if(token){
    checkin();
  }else{
    startScanner();
  }
}

// SAVE NIM
function saveNIM(){
  const nim = nimInput.value.trim();
  if(!nim){
    alert("NIM wajib diisi");
    return;
  }

  user_id = nim;
  localStorage.setItem("nim", nim);

  loginBox.style.display="none";
  scanBox.style.display="block";

  if(token){
    checkin();
  }else{
    startScanner();
  }
}

// CHECKIN
async function checkin(){
  setStatus("â³ Mengirim presensi...", "loading");

  try{
    const res = await fetch(BASE+"?path=/presence/checkin",{
      method:"POST",
      body:JSON.stringify({
        user_id:user_id,
        device_id:device_id,
        course_id:course,
        session_id:session,
        qr_token:token,
        ts:new Date().toISOString()
      })
    });

    const json = await res.json();

    if(json.ok){
      setStatus("âœ… PRESENSI BERHASIL", "success");

      const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
      audio.play();

    }else{
      setStatus("âŒ "+json.error, "error");
    }

  }catch(err){
    setStatus("âŒ Gagal koneksi server", "error");
  }
}

// SCANNER
function startScanner(){
  const scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:220 },
    text=>{
      scanner.stop();
      location.href = text;
    }
  );
}

// STATUS
function setStatus(text, type){
  statusEl.innerText = text;
  statusEl.className = type;
}
</script>

</body>
</html>