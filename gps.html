<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GPS Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
#map{height:400px;}
</style>
</head>

<body>

<h2>GPS Tracking</h2>
<button onclick="start()">Start Tracking</button>
<p id="status"></p>

<div id="map"></div>

<script>
const BASE_URL="https://script.google.com/macros/s/AKfycbytvsRFhjR45af_ly5AiHv-c2gPJ5oRADjfREgFDHB3N2VTn5NBcY7Q3CW8XcVv10qY/exec"; // ganti
const device_id="dev-"+Math.random().toString(36).substring(2,8);

let map=L.map("map").setView([-7.25,112.75],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker=null;
let polyline=L.polyline([],{color:"blue"}).addTo(map);

// ================= GPS =================
function start(){
  if(!navigator.geolocation){
    alert("GPS tidak tersedia");
    return;
  }

  navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    const acc=pos.coords.accuracy;

    status.innerText=`Lat:${lat} Lng:${lng}`;

    sendGPS(lat,lng,acc);
    updateMap(lat,lng);

  },err=>{
    alert("GPS error");
  },{
    enableHighAccuracy:true,
    maximumAge:0,
    timeout:5000
  });

  setInterval(loadHistory,5000);
}

// ================= SEND GPS =================
async function sendGPS(lat,lng,acc){
  await fetch(BASE_URL+"?path=/telemetry/gps",{
    method:"POST",
    body:JSON.stringify({
      device_id:device_id,
      ts:new Date().toISOString(),
      lat:lat,
      lng:lng,
      accuracy_m:acc
    })
  });
}

// ================= MAP =================
function updateMap(lat,lng){
  if(!marker){
    marker=L.marker([lat,lng]).addTo(map);
  }else{
    marker.setLatLng([lat,lng]);
  }
}

// ================= HISTORY (POLYLINE) =================
async function loadHistory(){
  const res=await fetch(BASE_URL+"?path=/telemetry/gps/history&device_id="+device_id+"&limit=100");
  const json=await res.json();

  if(json.ok){
    const points=json.data.items.map(p=>[p.lat,p.lng]);
    polyline.setLatLngs(points);
  }
}
</script>

</body>
</html>